<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TISS-28 Multipaciente – Hospital Alemán de Buenos Aires</title>
<style>
  :root{
    --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff;
    --border:#e2e8f0; --accent:#b91c1c; --soft:#f1f5f9; --danger:#b91c1c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.4}
  .container{max-width:1180px;margin:0 auto;padding:24px;border-top:6px solid var(--accent)}
  header .row{display:flex;gap:16px;align-items:center;margin-bottom:12px}
  header img{height:60px}
  h1{font-size:24px;margin:0;color:var(--accent)}
  h2{font-size:18px;margin:0 0 10px}
  h3{font-size:16px;margin:0 0 10px}
  p.small{color:var(--muted);font-size:12px;margin:6px 0 0}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 1px 2px rgba(2,8,23,.04)}
  ul{list-style:none;padding:0;margin:0}
  li{display:flex;gap:10px;align-items:flex-start}
  li + li{margin-top:8px}
  label{cursor:pointer}
  .badge{font-size:11px;color:var(--muted);margin-left:6px}
  .muted{font-size:11px;color:var(--muted)}
  .row3{display:grid;gap:10px}
  @media(min-width:620px){.row3{grid-template-columns:repeat(3,1fr)}}
  .pill{background:var(--soft);border:1px solid var(--border);padding:10px;border-radius:12px;font-size:14px}
  .pill strong{font-weight:700}
  .pill.danger{color:var(--danger);border-color:#fecaca;background:#fff1f2}
  .buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  button,.btn{border:0;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:600}
  .btn-dark{background:#0f172a;color:#fff}
  .btn-mid{background:#334155;color:#fff}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-light{background:#e2e8f0}
  input[type=file]{display:none}
  footer{color:var(--muted);font-size:12px;margin-top:18px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* Pacientes panel */
  .patients{display:flex;flex-direction:column;gap:10px}
  .patients .list{max-height:280px;overflow:auto;border:1px solid var(--border);border-radius:12px}
  .patients .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border)}
  .patients .item:last-child{border-bottom:0}
  .patients .item.active{background:#fff7f7}
  .patients .item .id{font-weight:700}
  .patients .item .sub{font-size:12px;color:var(--muted)}

  /* Print styling */
  @media print {
    .no-print { display:none !important; }
    body { background:#fff; }
    .container { border-top:0; }
    .card { box-shadow:none; border:1px solid #ddd; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="row">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Hospital_Alem%C3%A1n_logo.png/320px-Hospital_Alem%C3%A1n_logo.png" alt="Logo Hospital Alemán">
      <div>
        <h1>Hospital Alemán de Buenos Aires</h1>
        <div style="color:#475569">Unidad Coronaria – TISS-28 Multipaciente</div>
        <p class="small">1 punto ≈ 10,6 min de enfermería por turno de 8 h · Basado en Miranda et al., 1996 y esquema SFAR.</p>
      </div>
    </div>
  </header>

  <section class="grid">
    <!-- Left: Patient list & controls -->
    <div class="card">
      <h2>Pacientes</h2>
      <div class="patients">
        <div class="no-print">
          <div style="display:grid;gap:8px;grid-template-columns:1.2fr 1fr 1fr">
            <input id="inName" placeholder="Nombre y apellido" />
            <input id="inMRN" placeholder="Historia clínica / ID" />
            <button class="btn-accent" id="btnAdd">Agregar</button>
          </div>
        </div>
        <div class="list" id="patientsList" aria-live="polite"></div>
        <div class="buttons no-print">
          <button class="btn-light" id="btnDup">Duplicar seleccionado</button>
          <button class="btn-light" id="btnDel">Eliminar seleccionado</button>
        </div>
      </div>
      <hr style="margin:16px 0;border:0;border-top:1px solid var(--border)" class="no-print">
      <div class="no-print">
        <h3>Integración con Google Sheets</h3>
        <div style="display:grid;gap:8px;grid-template-columns:1fr">
          <input id="webAppUrl" placeholder="Pegá aquí la URL del Web App de Google Apps Script (doPost)" />
          <input id="sheetId" placeholder="Opcional: Spreadsheet ID (si querés que el Apps Script lo reciba y use)" />
          <input id="sheetName" placeholder="Nombre de hoja (ej.: TISS28)" value="TISS28" />
        </div>
        <div class="buttons" style="margin-top:8px">
          <button class="btn-dark" id="btnSendSheets">Enviar pacientes a Google Sheets</button>
        </div>
        <p class="small">Guardaremos la URL en tu navegador (localStorage). El envío realiza un POST JSON con todas las filas.</p>
      </div>
      <hr style="margin:16px 0;border:0;border-top:1px solid var(--border)" class="no-print">
      <div class="no-print">
        <h3>Archivo</h3>
        <div class="buttons">
          <button class="btn-mid" id="btnSaveAll">Guardar estado (JSON)</button>
          <label class="btn-light">Cargar estado<input type="file" id="fileAll" accept="application/json"></label>
          <button class="btn-light" id="btnCSVAll">Exportar CSV (todos)</button>
          <button class="btn-accent" id="btnPrint">Imprimir / Guardar PDF</button>
        </div>
      </div>
    </div>

    <!-- Right: TISS checklist for selected patient -->
    <div id="rightPane" class="card">
      <h2 id="titleChk">Checklist TISS-28</h2>
      <section id="categories"></section>
      <section class="card" style="margin-top:16px">
        <h3>Resultados del paciente seleccionado</h3>
        <div class="row3">
          <div class="pill">Puntos TISS-28: <strong id="pts">0</strong></div>
          <div class="pill">Tiempo estimado/turno: <strong id="mins">0.0</strong> min</div>
          <div class="pill" id="loadPill">Carga de turno (8 h): <strong id="load">0%</strong></div>
        </div>
        <p class="small">Referencia: ≈46 puntos por enfermero por turno (ajustar localmente).</p>
      </section>
    </div>
  </section>

  <footer>
    <p>Exclusiones automáticas: VM excluye soporte suplementario; múltiples vasoactivos excluye uno; múltiples intervenciones específicas en UCI excluye única intervención; múltiples fármacos IV excluye un solo fármaco.</p>
    <p>Hospital Alemán de Buenos Aires – Av. Pueyrredón 1640, C1118AAT – CABA – Tel: +54 11 4827-7000</p>
  </footer>
</div>

<script>
// ====== Configuración ======
const MIN_PER_POINT = 10.6;  // minutos por punto
const SHIFT_MIN = 8 * 60;    // 480 min
const SCHEMA = [
  {category:"Actividades básicas", items:[
    {id:"basic_standard_monitoring", label:"Monitoreo estándar (signos vitales horarios, balance hídrico)", pts:5},
    {id:"basic_laboratory", label:"Laboratorio (bioquímica / microbiología)", pts:1},
    {id:"basic_single_med", label:"Un medicamento (cualquier vía)", pts:2, exclusiones:["basic_multi_meds"]},
    {id:"basic_multi_meds", label:"Múltiples medicamentos IV (más de uno, en bolo o perfusión)", pts:3, exclusiones:["basic_single_med"]},
    {id:"basic_routine_dressings", label:"Curaciones rutinarias / prevención de escaras (diarias)", pts:1},
    {id:"basic_freq_dressings", label:"Curaciones frecuentes (≥1 por turno) y/o heridas extensas", pts:1},
    {id:"basic_drains", label:"Cuidado de drenajes (todos excepto SNG)", pts:3},
  ]},
  {category:"Soporte ventilatorio", items:[
    {id:"vent_mech", label:"Ventilación mecánica (incluye asistida/PEEP/relajantes; o espontánea con PEEP)", pts:5, exclusiones:["vent_supp"]},
    {id:"vent_supp", label:"Soporte ventilatorio supl. (espontánea por TET sin PEEP; O₂ por cualquier método si NO hay VM)", pts:2, exclusiones:["vent_mech"]},
    {id:"vent_airway_care", label:"Cuidado de vía aérea artificial (TET o traqueostomía)", pts:1},
    {id:"vent_lung_treatment", label:"Tratamiento para mejorar función pulmonar (kinesioterapia, inspirometría, nebulizaciones, succión)", pts:1},
  ]},
  {category:"Soporte cardiovascular", items:[
    {id:"cv_single_vaso", label:"Un vasoactivo (cualquiera)", pts:3, exclusiones:["cv_multi_vaso"]},
    {id:"cv_multi_vaso", label:"Múltiples vasoactivos (más de uno, cualquier dosis)", pts:4, exclusiones:["cv_single_vaso"]},
    {id:"cv_large_fluid_replacement", label:"Reposición IV de grandes pérdidas (>3 L/m²/día)", pts:4},
    {id:"cv_art_line", label:"Catéter arterial periférico", pts:5},
    {id:"cv_la_pac", label:"Monitoreo de AIz/PAC ± gasto cardíaco", pts:8},
    {id:"cv_cvc", label:"Línea venosa central", pts:2},
    {id:"cv_cpr_24h", label:"RCP en últimas 24 h (excluye golpe precordial aislado)", pts:3},
  ]},
  {category:"Soporte renal", items:[
    {id:"renal_hemofiltration", label:"Hemofiltración/técnicas dialíticas", pts:3},
    {id:"renal_q_urine", label:"Diuresis cuantificada (medición horaria)", pts:2},
    {id:"renal_active_diuresis", label:"Diuresis activa (p. ej., furosemida >0,5 mg/kg/día)", pts:3},
  ]},
  {category:"Soporte neurológico", items:[
    {id:"neuro_icp", label:"Medición de presión intracraneal", pts:4},
  ]},
  {category:"Soporte metabólico", items:[
    {id:"metab_acid_base", label:"Tratamiento de acidosis/alcalosis metabólica complicada", pts:4},
    {id:"metab_tpn", label:"Nutrición parenteral total", pts:3},
    {id:"metab_enteral", label:"Nutrición enteral (SNG u otra vía GI)", pts:2},
  ]},
  {category:"Intervenciones específicas", items:[
    {id:"spec_single_in_icu", label:"Una intervención específica EN UCI (intubación, marcapasos, cardioversión, endoscopía, cirugía urgente <24 h, lavado gástrico)", pts:3, exclusiones:["spec_multi_in_icu"]},
    {id:"spec_multi_in_icu", label:"Múltiples intervenciones específicas EN UCI (más de una de las anteriores)", pts:5, exclusiones:["spec_single_in_icu"]},
    {id:"spec_outside_icu", label:"Intervención específica FUERA de UCI (cirugía o procedimientos diagnósticos)", pts:5},
  ]},
];

// ====== Estado (multipaciente) ======
let patients = []; // [{id, name, mrn, checked:{}, createdAt}]
let selectedIdx = -1;

function uid(){ return Math.random().toString(36).slice(2,9); }

// ====== Util ======
function $(sel,root=document){ return root.querySelector(sel); }
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") n.className = v;
    else if (k === "for") n.htmlFor = v;
    else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else if (v !== false && v != null) n.setAttribute(k, v === true ? "" : v);
  }
  for (const c of children){
    if (c == null) continue;
    n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  }
  return n;
}

function totalPoints(checked){
  let sum=0;
  SCHEMA.forEach(cat => cat.items.forEach(it => { if (checked[it.id]) sum += it.pts; }));
  return sum;
}

// ====== Pacientes UI ======
function renderPatients(){
  const list = $("#patientsList");
  list.innerHTML = "";
  patients.forEach((p, idx) => {
    const pts = totalPoints(p.checked);
    const item = el("div", {class:"item"+(idx===selectedIdx?" active":"")});
    const left = el("div", {},
      el("div", {class:"id"}, p.name || "Sin nombre"),
      el("div", {class:"sub"}, `${p.mrn || "Sin ID"} · ${pts} pts`)
    );
    const right = el("div", {}, el("button", {class:"btn-light", onClick:()=>{selectedIdx=idx; renderPatients(); renderChecklist();}}, "Seleccionar"));
    item.append(left, right);
    list.appendChild(item);
  });
  if (selectedIdx === -1 && patients.length > 0){ selectedIdx = 0; }
}

function addPatient(name, mrn){
  patients.push({ id: uid(), name, mrn, checked:{}, createdAt: new Date().toISOString() });
  selectedIdx = patients.length - 1;
  renderPatients();
  renderChecklist();
}

function duplicateSelected(){
  if (selectedIdx < 0) return;
  const base = patients[selectedIdx];
  patients.push({ id: uid(), name: base.name+" (copia)", mrn: base.mrn, checked: {...base.checked}, createdAt: new Date().toISOString() });
  selectedIdx = patients.length - 1;
  renderPatients(); renderChecklist();
}

function deleteSelected(){
  if (selectedIdx < 0) return;
  patients.splice(selectedIdx,1);
  selectedIdx = patients.length ? 0 : -1;
  renderPatients(); renderChecklist();
}

// ====== Checklist UI ======
function renderChecklist(){
  const pane = $("#categories");
  const title = $("#titleChk");
  pane.innerHTML = "";
  const p = patients[selectedIdx];
  if (!p){ title.textContent = "Checklist TISS-28"; $("#pts").textContent="0"; $("#mins").textContent="0.0"; $("#load").textContent="0%"; return; }
  title.textContent = `Checklist TISS-28 – ${p.name || "Sin nombre"} (${p.mrn || "Sin ID"})`;

  SCHEMA.forEach(cat => {
    const box = el("div", {class:"card"});
    box.appendChild(el("h3", {}, cat.category));
    const list = el("ul");
    cat.items.forEach(it => {
      const id = it.id;
      const input = el("input", {type:"checkbox", id:`${p.id}_${id}`, checked: !!p.checked[id], onChange: () => toggleItem(p, id, it.exclusiones)});
      const label = el("label", {"for":`${p.id}_${id}`},
        el("span", {style:"font-weight:600"}, it.label),
        el("span", {class:"badge"}, `(+${it.pts} pts)`),
        it.exclusiones ? el("div", {class:"muted"}, `* Exclusivo con: ${it.exclusiones.map(e=>e.replaceAll('_',' ')).join(", ")}`) : null
      );
      list.appendChild(el("li", {}, input, label));
    });
    box.appendChild(list);
    pane.appendChild(box);
  });
  updateTotals();
}

function toggleItem(p, id, exclusiones){
  p.checked[id] = !p.checked[id];
  if (p.checked[id] && Array.isArray(exclusiones)){
    exclusiones.forEach(exId => { p.checked[exId] = false; });
  }
  renderChecklist();
}

function updateTotals(){
  const p = patients[selectedIdx];
  const pts = p ? totalPoints(p.checked) : 0;
  const mins = pts * MIN_PER_POINT;
  const load = (mins / SHIFT_MIN) * 100;
  $("#pts").textContent = pts;
  $("#mins").textContent = mins.toFixed(1);
  $("#load").textContent = `${Math.round(load)}%`;
  $("#loadPill").classList.toggle("danger", load > 100);
}

// ====== Archivo (JSON/CSV) ======
function saveAll(){
  const payload = { patients, generatedAt: new Date().toISOString(), version:"multipaciente-v1" };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `tiss28_multipaciente_${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(url);
}

function loadAll(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(String(reader.result));
      if (Array.isArray(data.patients)){
        patients = data.patients;
        selectedIdx = patients.length ? 0 : -1;
        renderPatients(); renderChecklist();
      } else { alert("Archivo inválido."); }
    }catch(e){ alert("Archivo inválido."); }
  };
  reader.readAsText(file);
}

function exportCSVAll(){
  const rows = [["Nombre","ID/HC","Puntos","Min/turno","Carga(%)","Fecha"]];
  patients.forEach(p => {
    const pts = totalPoints(p.checked);
    const mins = pts * MIN_PER_POINT;
    const load = Math.round((mins/SHIFT_MIN)*100);
    rows.append;
    rows.push([p.name||"", p.mrn||"", String(pts), mins.toFixed(1), String(load), new Date().toISOString()]);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `tiss28_multi_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
}

// ====== Google Sheets (Apps Script Web App) ======
function toRows(){
  return patients.map(p => {
    const pts = totalPoints(p.checked);
    const mins = pts * MIN_PER_POINT;
    const load = Math.round((mins/SHIFT_MIN)*100);
    return {
      name: p.name||"",
      mrn: p.mrn||"",
      points: pts,
      minutes: Number(mins.toFixed(1)),
      loadPct: load,
      createdAt: p.createdAt,
      exportedAt: new Date().toISOString()
    };
  });
}

async function sendToSheets(){
  const url = $("#webAppUrl").value.trim();
  const sheetId = $("#sheetId").value.trim();
  const sheetName = $("#sheetName").value.trim() || "TISS28";
  if (!url){ alert("Pegá la URL del Web App de Apps Script."); return; }
  localStorage.setItem("tiss28_webAppUrl", url);
  localStorage.setItem("tiss28_sheetId", sheetId);
  localStorage.setItem("tiss28_sheetName", sheetName);

  const payload = { sheetId, sheetName, rows: toRows() };
  try{
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    alert(res.ok ? "Enviado correctamente a Google Sheets." : "Error al enviar: " + txt);
  }catch(e){
    alert("No se pudo enviar: " + e.message);
  }
}

// ====== Init ======
document.addEventListener("DOMContentLoaded", () => {
  // Local storage defaults
  $("#webAppUrl").value = localStorage.getItem("tiss28_webAppUrl") || "";
  $("#sheetId").value = localStorage.getItem("tiss28_sheetId") || "";
  $("#sheetName").value = localStorage.getItem("tiss28_sheetName") || "TISS28";

  // Buttons
  $("#btnAdd").addEventListener("click", () => {
    const name = $("#inName").value.trim(); const mrn = $("#inMRN").value.trim();
    if (!name && !mrn){ alert("Ingresá al menos Nombre o ID."); return; }
    addPatient(name, mrn); $("#inName").value=""; $("#inMRN").value="";
  });
  $("#btnDup").addEventListener("click", duplicateSelected);
  $("#btnDel").addEventListener("click", deleteSelected);
  $("#btnSaveAll").addEventListener("click", saveAll);
  $("#fileAll").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0]; if (f) loadAll(f); e.target.value="";
  });
  $("#btnCSVAll").addEventListener("click", exportCSVAll);
  $("#btnPrint").addEventListener("click", () => window.print());
  $("#btnSendSheets").addEventListener("click", sendToSheets);

  // Start
  renderPatients(); renderChecklist();
});
</script>
</body>
</html>