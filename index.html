<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TISS-28 – Calculadora online (UCI/UCC)</title>
<style>
  :root{
    --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff;
    --border:#e2e8f0; --accent:#0f172a; --soft:#f1f5f9; --danger:#b91c1c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.4}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  h1{font-size:26px;margin:0 0 6px}
  h2{font-size:18px;margin:0 0 10px}
  h3{font-size:16px;margin:0 0 10px}
  p.small{color:var(--muted);font-size:12px;margin:6px 0 0}
  .grid{display:grid;gap:16px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 1px 2px rgba(2,8,23,.04)}
  ul{list-style:none;padding:0;margin:0}
  li{display:flex;gap:10px;align-items:flex-start}
  li + li{margin-top:8px}
  label{cursor:pointer}
  .badge{font-size:11px;color:var(--muted);margin-left:6px}
  .muted{font-size:11px;color:var(--muted)}
  .row{display:grid;gap:10px}
  @media(min-width:620px){.row{grid-template-columns:repeat(3,1fr)}}
  .pill{background:var(--soft);border:1px solid var(--border);padding:10px;border-radius:12px;font-size:14px}
  .pill strong{font-weight:700}
  .pill.danger{color:var(--danger);border-color:#fecaca;background:#fff1f2}
  .buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  button,.btn{border:0;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:600}
  .btn-dark{background:var(--accent);color:#fff}
  .btn-mid{background:#334155;color:#fff}
  .btn-light{background:#e2e8f0}
  input[type=file]{display:none}
  footer{color:var(--muted);font-size:12px;margin-top:18px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<div class="container" style="border-top:6px solid #b91c1c;">
  <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Hospital_Alem%C3%A1n_logo.png/320px-Hospital_Alem%C3%A1n_logo.png" alt="Logo Hospital Alemán" style="height:60px;">
    <div>
      <h1 style="margin:0; font-size:24px; color:#b91c1c;">Hospital Alemán de Buenos Aires</h1>
      <p style="margin:0; font-size:14px; color:#475569;">Unidad Coronaria – Departamento de Cuidados Críticos</p>
    </div>
  </div>
  <header>
    <h1>TISS-28 – Calculadora online (UCI/UCC)</h1>
<p style="font-weight:bold; color:#b91c1c; font-size:18px;">Hospital Alemán de Buenos Aires</p>
    <p class="small">Basado en Miranda et al., Crit Care Med 1996 y esquema SFAR. Regla: 1 punto ≈ 10,6 min de enfermería por turno de 8 h.</p>
  </header>

  <section id="categories" class="grid"></section>

  <section class="card" style="margin-top:16px">
    <h3>Resultados</h3>
    <div class="row">
      <div class="pill">Puntos TISS-28: <strong id="pts">0</strong></div>
      <div class="pill">Tiempo estimado/turno: <strong id="mins">0.0</strong> min</div>
      <div class="pill" id="loadPill">Carga de turno (8 h): <strong id="load">0%</strong></div>
    </div>
    <p class="small">Referencia clásica: ≈46 puntos por enfermero por turno (ajuste según protocolos locales).</p>
    <div class="buttons">
      <button class="btn-dark" id="btnCsv">Exportar CSV</button>
      <button class="btn-mid" id="btnSave">Guardar estado (JSON)</button>
      <label class="btn-light">
        Cargar estado <input type="file" id="fileJson" accept="application/json">
      </label>
      <button class="btn-light" id="btnClear">Limpiar</button>
    </div>
  </section>

  <footer>
    <p>Exclusiones automáticas: VM excluye soporte suplementario; múltiples vasoactivos excluye uno; múltiples intervenciones específicas en UCI excluye única intervención; múltiples fármacos IV excluye un solo fármaco.</p>
    <p>Este recurso no sustituye protocolos locales.</p>
  <p style="margin-top:16px; font-size:12px; color:#475569;">Hospital Alemán de Buenos Aires – Av. Pueyrredón 1640, C1118AAT – Ciudad Autónoma de Buenos Aires – Tel: +54 11 4827-7000</p>
</footer>
</div>

<script>
// ====== Configuración y datos ======
const MIN_PER_POINT = 10.6;  // minutos por punto
const SHIFT_MIN = 8 * 60;    // 480 min

const SCHEMA = [
  {
    category: "Actividades básicas",
    items: [
      { id: "basic_standard_monitoring", label: "Monitoreo estándar (signos vitales horarios, balance hídrico)", pts: 5 },
      { id: "basic_laboratory", label: "Laboratorio (bioquímica / microbiología)", pts: 1 },
      { id: "basic_single_med", label: "Un medicamento (cualquier vía)", pts: 2, exclusiones: ["basic_multi_meds"] },
      { id: "basic_multi_meds", label: "Múltiples medicamentos IV (más de uno, en bolo o perfusión)", pts: 3, exclusiones: ["basic_single_med"] },
      { id: "basic_routine_dressings", label: "Curaciones rutinarias / prevención de escaras (diarias)", pts: 1 },
      { id: "basic_freq_dressings", label: "Curaciones frecuentes (≥1 por turno) y/o heridas extensas", pts: 1 },
      { id: "basic_drains", label: "Cuidado de drenajes (todos excepto SNG)", pts: 3 },
    ],
  },
  {
    category: "Soporte ventilatorio",
    items: [
      { id: "vent_mech", label: "Ventilación mecánica (incluye asistida/PEEP/relajantes; o espontánea con PEEP)", pts: 5, exclusiones: ["vent_supp"] },
      { id: "vent_supp", label: "Soporte ventilatorio supl. (espontánea por TET sin PEEP; O₂ por cualquier método si NO hay VM)", pts: 2, exclusiones: ["vent_mech"] },
      { id: "vent_airway_care", label: "Cuidado de vía aérea artificial (TET o traqueostomía)", pts: 1 },
      { id: "vent_lung_treatment", label: "Tratamiento para mejorar función pulmonar (kinesioterapia, inspirometría, nebulizaciones, succión)", pts: 1 },
    ],
  },
  {
    category: "Soporte cardiovascular",
    items: [
      { id: "cv_single_vaso", label: "Un vasoactivo (cualquiera)", pts: 3, exclusiones: ["cv_multi_vaso"] },
      { id: "cv_multi_vaso", label: "Múltiples vasoactivos (más de uno, cualquier dosis)", pts: 4, exclusiones: ["cv_single_vaso"] },
      { id: "cv_large_fluid_replacement", label: "Reposición IV de grandes pérdidas (>3 L/m²/día)", pts: 4 },
      { id: "cv_art_line", label: "Catéter arterial periférico", pts: 5 },
      { id: "cv_la_pac", label: "Monitoreo de AIz/PAC ± gasto cardíaco", pts: 8 },
      { id: "cv_cvc", label: "Línea venosa central", pts: 2 },
      { id: "cv_cpr_24h", label: "RCP en últimas 24 h (excluye golpe precordial aislado)", pts: 3 },
    ],
  },
  {
    category: "Soporte renal",
    items: [
      { id: "renal_hemofiltration", label: "Hemofiltración/técnicas dialíticas", pts: 3 },
      { id: "renal_q_urine", label: "Diuresis cuantificada (medición horaria)", pts: 2 },
      { id: "renal_active_diuresis", label: "Diuresis activa (p. ej., furosemida >0,5 mg/kg/día)", pts: 3 },
    ],
  },
  {
    category: "Soporte neurológico",
    items: [
      { id: "neuro_icp", label: "Medición de presión intracraneal", pts: 4 },
    ],
  },
  {
    category: "Soporte metabólico",
    items: [
      { id: "metab_acid_base", label: "Tratamiento de acidosis/alcalosis metabólica complicada", pts: 4 },
      { id: "metab_tpn", label: "Nutrición parenteral total", pts: 3 },
      { id: "metab_enteral", label: "Nutrición enteral (SNG u otra vía GI)", pts: 2 },
    ],
  },
  {
    category: "Intervenciones específicas",
    items: [
      { id: "spec_single_in_icu", label: "Una intervención específica EN UCI (intubación, marcapasos, cardioversión, endoscopía, cirugía urgente <24 h, lavado gástrico)", pts: 3, exclusiones: ["spec_multi_in_icu"] },
      { id: "spec_multi_in_icu", label: "Múltiples intervenciones específicas EN UCI (más de una de las anteriores)", pts: 5, exclusiones: ["spec_single_in_icu"] },
      { id: "spec_outside_icu", label: "Intervención específica FUERA de UCI (cirugía o procedimientos diagnósticos)", pts: 5 },
    ],
  },
];

// ====== Estado ======
let checked = Object.create(null);

// ====== Utilidades ======
function $(sel, root=document){ return root.querySelector(sel); }
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") n.className = v;
    else if (k === "for") n.htmlFor = v;
    else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else if (v !== false && v != null) n.setAttribute(k, v === true ? "" : v);
  }
  for (const c of children){
    if (c == null) continue;
    n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  }
  return n;
}

// ====== Render ======
function renderCategories(){
  const root = $("#categories");
  root.innerHTML = "";
  SCHEMA.forEach(cat => {
    const box = el("div", {class:"card"});
    box.appendChild(el("h2", {}, cat.category));
    const list = el("ul");
    cat.items.forEach(it => {
      const id = it.id;
      const input = el("input", {type:"checkbox", id, checked: !!checked[id], onChange: () => toggle(id, it.exclusiones)});
      const label = el("label", {"for":id},
        el("span", {style:"font-weight:600"}, it.label),
        el("span", {class:"badge"}, `(+${it.pts} pts)`),
        it.exclusiones ? el("div", {class:"muted"}, `* Exclusivo con: ${it.exclusiones.map(e=>e.replaceAll('_',' ')).join(", ")}`) : null
      );
      const li = el("li", {}, input, label);
      list.appendChild(li);
    });
    box.appendChild(list);
    root.appendChild(box);
  });
}

function computeTotals(){
  let sum = 0;
  SCHEMA.forEach(cat => cat.items.forEach(it => { if (checked[it.id]) sum += it.pts; }));
  const totalMinutes = sum * MIN_PER_POINT;
  const load = (totalMinutes / SHIFT_MIN) * 100;

  $("#pts").textContent = sum;
  $("#mins").textContent = totalMinutes.toFixed(1);
  $("#load").textContent = `${Math.round(load)}%`;

  const pill = $("#loadPill");
  pill.classList.toggle("danger", load > 100);
}

function toggle(id, exclusiones){
  checked[id] = !checked[id];
  if (checked[id] && Array.isArray(exclusiones)){
    exclusiones.forEach(exId => { checked[exId] = false; });
  }
  renderCategories();
  computeTotals();
}

// ====== Export/Import ======
function exportCSV(){
  const rows = [["Categoría","Ítem","Seleccionado","Puntos"]];
  SCHEMA.forEach(cat => {
    cat.items.forEach(it => {
      rows.push([cat.category, it.label, checked[it.id] ? "Sí" : "No", checked[it.id] ? String(it.pts) : "0"]);
    });
  });
  const total = rows.push(["", "TOTAL", "", String(Object.keys(checked).reduce((s,id)=>s + (checked[id]?SCHEMA.flatMap(c=>c.items).find(x=>x.id===id)?.pts||0:0),0))]);
  const mins = rows.push(["", "Minutos estimados (8 h)", "", (Object.keys(checked).reduce((s,id)=>s + (checked[id]?SCHEMA.flatMap(c=>c.items).find(x=>x.id===id)?.pts||0:0),0) * MIN_PER_POINT).toFixed(1)]);

  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `tiss28_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
}

function saveJSON(){
  const payload = { checked, generatedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `tiss28_estado_${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(url);
}

function loadJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(String(reader.result));
      if (data && typeof data.checked === "object"){
        checked = data.checked || {};
        renderCategories();
        computeTotals();
      } else {
        alert("Archivo inválido.");
      }
    }catch(e){ alert("Archivo inválido."); }
  };
  reader.readAsText(file);
}

// ====== Init ======
document.addEventListener("DOMContentLoaded", () => {
  renderCategories();
  computeTotals();
  $("#btnCsv").addEventListener("click", exportCSV);
  $("#btnSave").addEventListener("click", saveJSON);
  $("#btnClear").addEventListener("click", () => { checked = Object.create(null); renderCategories(); computeTotals(); });
  $("#fileJson").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) loadJSON(file);
    e.target.value = "";
  });
});
</script>
</body>
</html>
